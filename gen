#!/usr/bin/env bash

# Generate: A command-line script file generation tool written in bash 3.2+.
# https://github.com/zpiatt/gen
#
# Copyright (C) 2022 Zac Piatt
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

readonly version="Generate (gen) version: 2.0.1 - July 30, 2023"

usage() {
	cat <<-EOF
	Usage: gen [OPTION]... [FILE]...
	Generate FILE, input script template, and launch default editor.

	  -c,   customize file permissions ( gen -c 754 example.sh )
	  -d,   use default template despite available custom template
	  -e,   manually select editor ( gen -e nano example.py )
	  -f,	overwrite existing file contents, never prompt
	  -h,   display help and exit
	  -q,   quiet automatic input of script template
	  -s,   suppress launch of editor
	  -v,   display version number and exit

	Full documentation <https://github.com/zpiatt/gen>
	or available locally via: info generate
	EOF
	exit 0
}

which_ed() {
	local editors=( "${VISUAL:-}" "${EDITOR:-}" nano vi emacs ed )
	for ed in "${editors[@]}"; do
		[[ -n "$ed" ]] && editor="$(command -v "$ed" 2> /dev/null)" && return 0
	done
	printf "No editor found in PATH.\n" >&2
	printf "Try 'gen -h' for more information.\n" >&2; exit 127
}

gen_template() {
	[[ -n "${template:-}" ]] && {
		local basename="${filename##*/}"
		printf "%s\n" "${template//basename/${basename%.*}}"; return 0; }
	
	printf "#!/usr/bin/env %s\n" "$ext"
}

create_file() {
	if [[ -f "$filename" && -z "$force" ]]; then
		read -erp "gen: overwrite '${filename}'? " overwrite
		[[ ! "${overwrite,,}" =~ ^y(es)?$ ]] && exit 0
	fi
	if [[ -f "$filename" ]]; then
		chmod "${custom_mode:-${mode:-u+rw}}" "$filename" || exit 126
		(: > "$filename") &> /dev/null || {
			printf "gen: %s: Permission denied\n" "$filename" >&2; exit 126; }
	else
		(: > "$filename") &> /dev/null || {
			printf "gen: %s: Permission denied\n" "$filename" >&2; exit 126; }
		chmod "${custom_mode:-${mode:-u+rw}}" "$filename" || { rm -f "$filename"; exit 126; }
	fi
}

check_ext() {
	case "${ext:-}" in
		py) mode="u+rwx" ;;
		awk) mode="u+rwx" ;;
		js) mode="u+rwx"; ext="node" ;;
		pl) mode="u+rwx"; ext="perl" ;;
		sh|bash) mode="u+rwx"; ext="bash" ;;
		*sh) mode="u+rwx" ;;
		*) [[ -z "$template" ]] && quiet=true ;;
	esac
}

get_template() {
	[[ -f "${HOME}/.gen/templates/template.${ext}" ]] && {
		template="$(< "${HOME}/.gen/templates/template.${ext}")"; }
}

get_args() {
	while getopts ':hqfdsc:ve:' option; do
		case "$option" in
			h) usage ;;
			q) quiet=true ;;
			f) force=true ;;
			d) default=true ;;
			s) suppress=true ;;
			c) custom_mode="$OPTARG" ;;
			v) printf "%s\n" "$version"; exit 0 ;;
			e)
				command -v "$OPTARG" &> /dev/null || {
					printf "gen: %s: not found\n" "$OPTARG" >&2
					printf "Try 'gen -h' for more information.\n" >&2; exit 127; }
				editor="$OPTARG"
			;;

			?)
				printf "gen: invalid option -- '%s'\n" "$OPTARG" >&2
				printf "Try 'gen -h' for more information.\n" >&2; exit 2
			;;
		esac
	done
	shift "$(( OPTIND -1 ))"
	[[ -z "${1:-}" ]] && {
		printf "gen: Must provide filename.\n" >&2
		printf "Try 'gen -h' for more information.\n" >&2; exit 2; }
	[[ -d "$1" ]] && { printf "gen: cannot generate '%s': Is a directory\n" "$1" >&2; exit 2; }
	filename="$1"
}

main() {
	get_args "$@"
	[[ "$filename" == *.* ]] && ext="${filename##*.}"
	[[ -z "${default:-}" && -n "${ext:-}" ]] && get_template
	check_ext
	create_file
	[[ -z "${quiet:-}" ]] && gen_template > "$filename"
	[[ -z "${suppress:-}" && -z "${editor:-}" ]] && which_ed
	[[ -z "${suppress:-}" ]] && "$editor" "$filename"
	return 0
}

main "$@"
