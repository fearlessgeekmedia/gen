#!/usr/bin/env bash

# Generate: A command-line script file generation tool written in bash 3.2+.
# https://github.com/membersincewayback/gen
#
# Copyright (C) 2022 Zac Piatt
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

version="Generate (gen) version: 1.4.1 - December 3, 2022"

get_template() {
    if [[ -n "${template_file:-}" ]]; then
        template="$(< "${template_file}")"
        format="templates"

gen_templates() {
cat <<[-]EOF
${template}
[-]EOF
}

    else

gen_py() {
cat << EOF
#!/usr/bin/env python
def main():

if __name__ == '__main__':
    main()
EOF
}

gen_pl() {
cat << EOF
#!/usr/bin/env perl
use strict;
use warnings;
EOF
}

gen_c() {
cat << EOF
#include <stdio.h>

int main()
{

   return 0;
}
EOF
}

gen_sh() {
cat << EOF
#!/usr/bin/env ${ext}
EOF
}

gen_html() {
cat << EOF
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>HTML 5 Boilerplate</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
        <script src="index.js"></script>
  </body>
</html>
EOF
}

gen_jsx() {
cat << EOF
import React from 'react';

function ${basename%.*}() {
  return (
    <>
    </>
  );
}

export default ${basename%.*};
EOF
}
    fi
}

usage() {
cat << EOF
Usage: gen [OPTION]... [FILE]...
Generate FILE, auto-input typical text, and auto-launch default editor.

  -x,   make file executable regardless of default
  -q,   quiet auto-input of script template
  -s,   suppress auto-launch of editor
  -e,   select editor ( gen -e nano test.txt )
  -d,   force default template despite available custom
  -v,   display version number and exit
  -h,   display this help and exit

Full documentation <https://github.com/membersincewayback/gen>
${version}
EOF
exit 0
}

launch_ed() {
    if ! "${EDITOR:-vi}" "${filename}" 2> /dev/null; then
        printf "Failed to launch editor.\n"
        printf "Try 'gen -h' for more information.\n"; exit 1
    fi
}

echo_text() {
    get_template
    gen_"${format:-sh}" >> "${filename}"
}

create_file() {
    if [[ -e "$filename" ]]; then
        printf "Filename already exists.\n"; exit 1
    else
        if ! touch "$filename" 2> /dev/null; then
            printf "Failed to create %s.\n" "$filename"; exit 1
        fi
    fi
}

check_ext() {
    case "$ext" in
        *awk) exe=true ;;
        *ksh) exe=true ;;
        *csh) exe=true ;;
        *c) format="c" ;;
        *jsx) format="jsx" ;;
        *html|*htm) format="html" ;;
        *sh) exe=true; ext="bash" ;;
        *js) exe=true; ext="node" ;;
        *py) exe=true; format="py" ;;
        *pl) exe=true; format="pl" ;;
        *) [[ -z "${template_file:-}" ]] && quiet=true ;;
    esac
}

get_args() {
    while getopts 'xqse:dvh' option; do
        case "$option" in
            h) usage ;;
            x) exe=true ;;
            q) quiet=true ;;
            s) suppress=true ;;
            e) EDITOR="$OPTARG" ;;
            d) unset template_file ;;
            v) printf "%s\n" "$version"; exit 0 ;;
            ?) printf "Try 'gen -h' for more information.\n"; exit 1 ;;
        esac
    done
}

check_template() {
    if [[ -n "${ext}" ]]; then
        [[ -f "${HOME}/.gen/templates/template.${ext}" ]] && \
            template_file="${HOME}/.gen/templates/template.${ext}"
    fi
}

get_ext() {
    case "${filename}" in
        *.*) ext="${filename##*.}" ;;
        *) ext=""
    esac
}

main() {
    filename="${!#}"
    basename="${filename##*/}"
    get_ext
    [[ -n "${ext}" ]] && check_template
    get_args "$@"
    check_ext
    create_file
    [[ "${exe:-}" ]] && chmod u+x "${filename}"
    [[ -z "${quiet:-}" ]] && echo_text
    [[ -z "${suppress:-}" ]] && launch_ed
}

if [[ "$#" -eq 0 ]]; then
    printf "Must provide filename to generate.\n"
    printf "Try 'gen -h' for more information.\n"; exit 1
else
    main "$@"
fi
